# Stackchan Test1 - 高機能セリフシステム完成版

このディレクトリはstackchanの基本テスト開発用で、**高機能セリフアニメーションシステム**が実装されています。

## ファイル構成

```
test1/
├── platformio.ini          # PlatformIO設定ファイル
├── src/
│   ├── main.cpp            # メインプログラム
│   ├── config.h            # 設定・セリフ管理ファイル
│   ├── TextAnimator.h      # セリフアニメーションクラス（ヘッダー）
│   └── TextAnimator.cpp    # セリフアニメーションクラス（実装）
├── data/
│   └── config.yaml         # YAML設定ファイル（現在は使用していない）
└── README.md               # このファイル
```

## 完成した機能一覧

### 🎭 基本システム
- **M5Stack Core2対応** (M5Stack CoreS3にも対応可能)
- **M5Stack-Avatar**による顔表示とセリフ吹き出し機能
- **日本語フォント**完全対応（文字化けなし）
- **config.h方式**での設定管理（SDカード不使用）

### 🎪 高機能セリフアニメーション (TextAnimatorクラス)

#### ✨ セリフ表示機能
- **11個のセリフ**をサポート（config.hで管理）
- **一文字ずつアニメーション表示**（0.1秒間隔）
- **UTF-8完全対応**（日本語ひらがな・カタカナ・漢字を正確に処理）
- **9文字スクロール機能**（9文字を超えると自動スクロール）
- **改行機能**（`\n`で分割表示、0.5秒間隔で次の行に進む）

#### 🎵 音響・表現機能
- **表情別ビープ音**（表情に応じて周波数が変化）
  - 中立: 1000Hz（標準）
  - 嬉しい: 1400Hz（高音・ポジティブ）
  - 怒り: 600Hz（低音・ネガティブ）
  - 悲しい: 500Hz（とても低音・ネガティブ）
  - 疑問: 1100Hz（やや高音）
  - 眠い: 800Hz（やや低音）
- **口形素解析**（文字に応じた口の動き制御）
  - あ行: 大きく開く (1.0)
  - い行: 小さく開く (0.3)
  - う行: 中程度に開く (0.8)
  - え行: 中程度に開く (0.5)
  - お行: 中程度に開く (0.8)
  - ん: ほぼ閉じる (0.1)
  - っ・ッ: 小さく開く (0.2)

#### 🔄 操作・制御機能
- **自動クリア**（2秒後に吹き出し消去）
- **セリフリピート機能**（前回再生したセリフを保存・再生）
- **アニメーション状態管理**（重複実行防止）
- **表情連動**（表情変更時にビープ音周波数も自動更新）

### 🎮 ボタン操作

| ボタン | 機能 | 詳細 |
|--------|------|------|
| **ボタンA** | セリフ表示 | 11個のセリフを順次循環表示（改行・スクロール対応） |
| **ボタンB** | セリフリピート | 前回再生したセリフを完全再現（改行含む） |
| **ボタンC** | 表情切り替え | 6種類の表情を循環＋ビープ音周波数自動調整 |

### 🌸 搭載セリフ（11個）

1. "こんにちは"
2. "元気ですか？"
3. "私はスタックチャンです"
4. "よろしくお願いします"
5. "ありがとうございます"
6. "今日はとても良いお天気ですね"
7. "テキストスクロール機能をテストしています"
8. "長いセリフも問題なく表示できるはずです"
9. "９文字以上の文字はスクロールします"
10. "改行コードを使うと\n分割表示もできます"
11. **"古池や\n蛙飛びこむ\n水の音"** ← 松尾芭蕉の俳句

## 技術仕様

### TextAnimatorクラスの特徴

#### UTF-8文字処理
- **バイトレベル解析**: UTF-8エンコーディングを正確に解析
- **マルチバイト対応**: 1〜4バイト文字を適切に処理
- **文字カウント**: 見た目の文字数を正確にカウント

#### アニメーション制御
- **ステートマシン**: 複数の状態を並行管理
  - is_animating（アニメーション実行中）
  - segment_pause_enabled（セグメント間一時停止）
  - auto_clear_enabled（自動クリア待機）
  - mouth_close_enabled（口閉じ待機）

#### 改行処理アルゴリズム
1. **segmentText()**: `\n`でテキストを最大10セグメントに分割
2. **セグメント順次処理**: 各セグメントを個別にアニメーション
3. **一時停止制御**: セグメント間で0.5秒の表示保持
4. **バルーンクリア**: 次セグメント開始時にバルーン内容をクリア

#### スクロール処理
- **MAX_DISPLAY_CHARS**: 9文字制限
- **getScrolledText()**: 表示範囲のテキスト抽出
- **動的更新**: 文字追加時に先頭文字を自動削除

### 設定管理（config.h）

#### セリフ配列
```cpp
const String LYRICS[] = {
  // ... 11個のセリフ
};
const int LYRICS_COUNT = sizeof(LYRICS) / sizeof(LYRICS[0]);
```

#### 表情別ビープ音設定
```cpp
const int BEEP_FREQUENCIES[] = {
  1000,  // 中立
  1400,  // 嬉しい
  600,   // 怒り
  500,   // 悲しい
  1100,  // 疑問
  800    // 眠い
};
```

### 依存ライブラリ

- **M5Unified**: M5Stack統合ライブラリ
- **M5Stack-Avatar**: アバター表示ライブラリ

## ビルド・実行方法

### 環境要件
- **PlatformIO**: 開発環境
- **M5Stack Core2**: 対象ハードウェア
- **ESP32**: マイコン（240MHz、4.3MB RAM、16MB Flash）

### ビルド手順
1. PlatformIO環境でこのディレクトリを開く
2. 必要に応じて`platformio.ini`のboard設定を調整
3. ビルド: `pio run --project-dir test1`
4. アップロード: `pio run --project-dir test1 --target upload`

### メモリ使用量（実測値）
- **RAM**: 0.6% (25,768 bytes / 4,521,984 bytes)
- **Flash**: 10.2% (670,997 bytes / 6,553,600 bytes)

## カスタマイズガイド

### セリフの追加・変更
`src/config.h`の`LYRICS[]`配列を編集:
```cpp
const String LYRICS[] = {
  "新しいセリフ1",
  "改行入り\nセリフ2",
  // ... 最大10個推奨
};
```

### ビープ音周波数の調整
`src/config.h`の`BEEP_FREQUENCIES[]`配列を編集:
```cpp
const int BEEP_FREQUENCIES[] = {
  1200,  // 中立（カスタム周波数）
  // ... 表情順に設定
};
```

### アニメーション速度の調整
`src/TextAnimator.h`のタイミング定数を編集:
```cpp
const unsigned long char_interval = 100;      // 文字間隔（ミリ秒）
const unsigned long segment_pause_duration = 500;  // セグメント間隔
```

## 制限事項

- **セグメント数**: 最大10セグメント（改行分割時）
- **表示文字数**: 9文字でスクロール開始
- **セリフ数**: 現在11個（拡張可能）
- **サーボ機能**: test1では未実装（test2以降で対応予定）

## 次のステップ（test2への引き継ぎ）

test1で完成した高機能セリフシステムをベースに、test2では以下の機能を追加予定：
- サーボ動作との連携
- より高度なアニメーション
- 外部API連携
- その他の拡張機能

---

**test1は高機能セリフシステムの完成版として、日本語音声表現の基盤が完成しました。**
