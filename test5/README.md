# Stackchan Test5 - JSON制御対応インタラクティブアバターシステム

M5Stack Core2 + M5Stack-Avatar + サーボモーター制御を統合した、test3をベースとした次世代の物理的な動きを持つ俳句朗読システムです。

## 🆕 新機能：JSON制御システム

### 📡 UART JSON制御
Port C（GPIO13/14）経由でJSON形式のメッセージを受信し、表情・動作・セリフを統合制御できます。

#### 📝 JSON形式
```json
{
  "message": [
    "古池や\n蛙飛びこむ\n水の音",
    "ふるいけや\nかわずとびこむ\nみずのおと"
  ],
  "expression": "Doubt",
  "motion": "nod"
}
```

#### 🎭 使用可能な表情（Expression）
| 英語名 | 日本語名 | 説明 |
|--------|----------|------|
| `Neutral` | `中立` | 標準的な表情 |
| `Happy` | `嬉しい` | 喜びの表情 |
| `Angry` | `怒り` | 怒りの表情 |
| `Sad` | `悲しい` | 悲しみの表情 |
| `Doubt` | `疑問` | 疑問・困惑の表情 |
| `Sleepy` | `眠い` | 眠そうな表情 |
| `Poet` | `俳人` | 瞑想的な表情（目を閉じる） |

#### 🤖 使用可能な動作（Motion）
| 英語名 | 日本語名 | 説明 |
|--------|----------|------|
| `nod` | `うなずき` | 1秒で下15度、1秒で戻るうなずき動作 |
| `shake` | `首振り` | 右20度→左20度→センターの首振り動作 |

#### 🔄 処理順序
1. **表情変更**: 指定された表情に即座に変更
2. **動作実行**: 指定された動作を実行（非同期）
3. **セリフ表示**: TextAnimatorによる発音・表示分離アニメーション

#### 📋 使用例
```json
// 疑問表情でうなずきながら俳句を朗読
{
  "message": ["古池や\n蛙飛びこむ\n水の音", "ふるいけや\nかわずとびこむ\nみずのおと"],
  "expression": "Doubt",
  "motion": "nod"
}

// 嬉しい表情で首振りしながら挨拶
{
  "message": ["こんにちは！", "こんにちは！"],
  "expression": "Happy", 
  "motion": "shake"
}

// 俳人表情（目を閉じて）で瞑想的に俳句朗読
{
  "message": ["山路来て\n何やらゆかし\nすみれ草", "やまじきて\nなにやらゆかし\nすみれぐさ"],
  "expression": "Poet",
  "motion": "nod"
}
```

## 🌟 主な機能

### 🤖 サーボ制御システム
- **2軸サーボ制御**: X軸（左右）・Y軸（上下）の滑らかな動作
- **イージング動作**: Cubic easing による自然な加速・減速
- **うなずき動作**: 1秒で下15度、1秒で戻る自然なうなずき
- **首振り動作**: 右20度→左20度→センターの滑らかな首振り
- **config.h設定**: ピン番号をconfig.hで一元管理

### 🎭 俳人表情システム
- **瞑想的表情**: 目を閉じた内省的な俳人らしい表情
- **自動まばたき制御**: 俳人モード時の確実な目閉じ維持
- **表情切り替え**: 7種類（中立/嬉しい/怒り/悲しい/疑問/眠い/俳人）

### 📝 漢字読み分離システム
- **表示**: 美しい漢字でそのまま表示
- **音響制御**: ひらがな読み文字列で正確なビープ音・リップシンク
- **完璧な俳句対応**: 松尾芭蕉「古池や蛙飛びこむ水の音」

### 🔊 PhoneticMouth（音素別口形状制御）
- **aiueo音素別制御**: あ行（大きく開いた口）、い行（横に広い口）など
- **カスタム口形状**: 外部から幅・高さを直接指定可能
```cpp
phoneticMouth->setPhoneme("あ");                    // 音素別設定
phoneticMouth->setCustomShape(30, 100, 15, 45);     // カスタム設定
phoneticMouth->applyToAvatar(&avatar);              // Avatar適用
```

## ⚙️ ハードウェア設定

### 🔌 サーボピン設定（config.h）
```cpp
// サーボ制御ピン（M5Stack Core2）
const int SERVO_X_PIN = 33;  // X軸サーボピン（GPIO33 = Port A）
const int SERVO_Y_PIN = 32;  // Y軸サーボピン（GPIO32 = Port A）
```

### 📐 サーボ初期位置設定
```cpp
const int SERVO_HOME_X = 82;   // X軸初期位置（右に10度）
const int SERVO_HOME_Y = 75;   // Y軸初期位置（上に15度）
```

### 🎯 動作範囲設定
```cpp
const int SERVO_NOD_DOWN = 90;         // うなずき下向き位置
const int SERVO_SHAKE_RIGHT = 60;      // 首振り右位置
const int SERVO_SHAKE_LEFT = 100;      // 首振り左位置
```

### 🔧 利用可能ピン
- **Port A**: GPIO32, GPIO33 (推奨・現在の設定)
- **Port B**: GPIO26, GPIO36
- **Port C**: GPIO13, GPIO14

## 📚 対応セリフ（11種類）

1. **こんにちは** - 基本挨拶
2. **元気ですか？** - 漢字読み分離対応
3. **私はスタックチャンです** - 自己紹介
4. **よろしくお願いします** - 丁寧語
5. **ありがとうございます** - 感謝表現
6. **今日はとても良いお天気ですね** - 長文対応
7. **テキストスクロール機能をテストしています** - 技術用語
8. **長いセリフも問題なく表示できるはずです** - スクロール機能
9. **９文字以上の文字はスクロールします** - 数字読み対応
10. **改行コードを使うと\n分割表示もできます** - 改行機能
11. **古池や\n蛙飛びこむ\n水の音** - 松尾芭蕉の俳句

## 🎮 操作方法

- **ボタンA**: セリフ順次再生（漢字読み分離・発音制御付き）
- **ボタンB**: サーボ動作（うなずき ⇔ 首振り 交互実行）
- **ボタンC**: 表情切り替え（俳人表情含む）

## 🔧 サーボ制御技術仕様

### 動作パラメータ
- **PWM周波数**: 50Hz
- **パルス幅**: 500-2400μs
- **更新間隔**: 20ms
- **イージング**: Cubic In-Out

### 動作パターン
```cpp
// うなずき動作
void performNod() {
  startEaseToY(NOD_DOWN_POSITION, 1000);  // 1秒で下へ
  startEaseToY(HOME_POSITION_Y, 1000);    // 1秒で戻る
}

// 首振り動作
void performHeadShake() {
  startEaseToX(SHAKE_RIGHT_POSITION, 500);  // 0.5秒で右へ
  startEaseToX(SHAKE_LEFT_POSITION, 1000);  // 1秒で左へ
  startEaseToX(HOME_POSITION_X, 500);       // 0.5秒でセンター
}
```

## 📁 ファイル構成

```
test5/
├── platformio.ini          # PlatformIO設定
├── src/
│   ├── main.cpp            # メイン処理（サーボ制御統合）
│   ├── config.h            # 設定・セリフ・サーボピン設定
│   ├── TextAnimator.h/cpp  # テキストアニメーション（発音分離対応）
│   ├── PhoneticMouth.h/cpp # 音素別口形状制御
│   ├── NarrowEye.h/cpp     # カスタム目（細い目）
│   └── PoetFace.h/cpp      # 俳人カスタム表情
├── data/
│   └── config.yaml         # 設定ファイル
└── README.md               # このファイル
```

## 🔧 技術仕様

### 依存ライブラリ
- M5Unified @ 0.1.16
- M5Stack-Avatar @ 0.10.0
- ESP32Servo @ 0.13.0

### ハードウェア対応
- **M5Stack Core2** (推奨・テスト済み)
- **サーボモーター**: SG90互換（2個）
- **電源**: 外部5V電源推奨（サーボ駆動用）

### メモリ使用量
- RAM: 0.6% (25,324 bytes)
- Flash: 6.8% (447,405 bytes)

## 🚀 ビルド・実行方法

1. **ハードウェア接続**
   - X軸サーボ: GPIO33 (Port A)
   - Y軸サーボ: GPIO32 (Port A)
   - 電源: 5V外部電源（サーボ用）

2. **ソフトウェア**
   ```bash
   pio run                    # ビルド
   pio run --target upload    # アップロード
   ```

## ⚙️ カスタマイズ

### サーボピンの変更
`src/config.h`のピン設定を変更：
```cpp
const int SERVO_X_PIN = 26;  // Port Bに変更する場合
const int SERVO_Y_PIN = 36;
```

### 動作範囲の調整
```cpp
const int SERVO_HOME_X = 90;    // センター位置
const int SERVO_HOME_Y = 90;    // センター位置
const int SERVO_NOD_DOWN = 105; // うなずき角度
```

### しゃべる速さの変更
```cpp
const unsigned long CHAR_DISPLAY_INTERVAL = 100;  // 標準: 0.1秒間隔
```

### セリフの追加・変更
```cpp
const SpeechData LYRICS[] = {
  {"表示文字列", "発音用ひらがな"},
  // 発音文字列が空("")の場合は表示文字列をそのまま使用
};
```

## 🏆 特徴

- **物理的表現**: デジタルアバターと物理的動作の融合
- **滑らかな動作**: イージング関数による自然な加速・減速
- **設定の一元管理**: config.hでピン・動作パラメータを統合管理
- **漢字読み分離**: 表示と発音の完全分離システム
- **俳句対応**: 日本の伝統文化を最新技術で表現

## 🎯 使用例

1. **俳句朗読デモ**
   - Button A: 「古池や蛙飛びこむ水の音」を美しい漢字で表示
   - Button B: 俳句に合わせてうなずき動作
   - Button C: 俳人表情（目を閉じた瞑想的表情）

2. **インタラクティブ対話**
   - Button A: 挨拶・会話セリフの順次再生
   - Button B: 相づち・首振りで感情表現
   - Button C: 表情変化で多彩な感情表現

3. **技術デモンストレーション**
   - 漢字表示と発音制御の分離技術
   - 物理的動作とデジタル表現の融合
   - 滑らかなサーボ制御とイージング

## 🔍 トラブルシューティング

### サーボが動かない場合
1. **電源確認**: 5V外部電源が接続されているか
2. **配線確認**: GPIO33(X軸)、GPIO32(Y軸)の接続
3. **シリアル出力確認**: サーボアタッチメッセージを確認

### 表示が文字化けする場合
1. **フォント設定**: 日本語フォントが正しく設定されているか
2. **文字エンコーディング**: UTF-8で保存されているか

### 動作が不安定な場合
1. **電源容量**: サーボ2個を駆動できる十分な電源容量
2. **配線品質**: ジャンパーワイヤーの接触不良確認

## 📝 ライセンス

MIT License - 自由に改変・配布可能

## 🌸 作者コメント

デジタルアバターと物理的な動作を融合させた、新しい形のインタラクティブシステムです。「古池や蛙飛びこむ水の音」を美しい漢字で表示しながら、正確な発音制御と物理的なうなずき動作で表現する、日本の伝統文化とテクノロジーが融合した革新的なシステムです。

サーボ制御により、単なる画面上の表現を超えて、物理的な存在感を持つスタックチャンを実現しています。
